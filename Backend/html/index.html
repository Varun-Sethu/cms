<!DOCTYPE html>
<html lang="en" style="height:100%;">

<head></head>
<body style="height:100%;">
    <div style="
        display: flex;
	    flex-direction: column;
	    flex-wrap: nowrap;
	    justify-content: center;
	    align-items: stretch;
	    align-content: stretch;">
        <div class="text_input" style="display:flex; height: 35vh;">
            <div contenteditable="true" id="document"></div>
        </div>
        <iframe id="real-time" style="display:flex; height: 60vh;" crossorigin="SAMEORIGIN"></iframe>
    </div>

    </div>
    <script src="js/diffmatchpatch/index.js" lang="javascript"></script>
    <script src="node_modules/codemirror/lib/codemirror.js"></script>
    <script src="node_modules/codemirror/mode/xml/xml.js"></script>
    <link rel="stylesheet" href="node_modules/codemirror/lib/codemirror.css">
    <script>
        var ce = document.getElementById("document");
        var text = ce.textContent || ce.innerText;
        var editor = CodeMirror(function(node){ce.parentNode.replaceChild(node, ce);}, {
            value: "",
            lineNumbers: true,
            mode: "xml",
        });
        
        var stateNew = true
        var shadow = ""
        
        // the client shadow
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        let socket = new WebSocket("ws://localhost:8080/edit?document=" + urlParams.get("document"))

        // Construct iframe
        var iframe = document.getElementById('real-time');
        iframe.src = `http://localhost:8080/preview?document=${urlParams.get("document")}`
        var dmp = new diff_match_patch();

        socket.onopen = () => {
            console.log("opened connection")
            iframe.src = iframe.src
        }
        socket.onclose = () => {
            console.log("disconnected")
        }


        let syncIncoming = (patches) => {
            // parse the patches
            var clientText = editor.getValue()

            var newClient = dmp.patch_apply(patches, clientText)[0];
            var newShadow = dmp.patch_apply(patches, shadow)[0];
            editor.setValue(newClient);
            shadow = newShadow;
        }

        let computeDiff = () => {
            var clientText = editor.getValue()
            var diff = dmp.patch_make(shadow, clientText)
            shadow = clientText
            return dmp.patch_toText(diff)
        }


        socket.onmessage = (message) => {
            if (!stateNew) {
                var patches = dmp.patch_fromText(message.data)
                if (patches.length === 0) {
                    iframe.src = iframe.src
                    return;
                }
                syncIncoming(patches)
                diff = computeDiff();
                socket.send(diff)
            } else {
                editor.setValue(message.data)
                shadow = message.data;
                stateNew = false
            }
            iframe.src = iframe.src
        }

        // react to spaces in the document
        document.addEventListener('keyup', event => {
            var diffs = computeDiff()
            socket.send(diffs)
            iframe.src = iframe.src
        });
    </script>

</body>

</html>